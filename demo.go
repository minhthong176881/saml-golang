package main

import (
	"crypto/x509"
	"fmt"
	"html/template"
	"net/http"
	"os"

	"io/ioutil"

	"encoding/base64"
	"encoding/xml"

	saml2 "github.com/russellhaering/gosaml2"
	"github.com/russellhaering/gosaml2/types"
	dsig "github.com/russellhaering/goxmldsig"
)

func main() {
	// res, err := http.Get("https://dev-9788402.okta.com/app/exk3lamm4nTIk1cFK5d7/sso/saml/metadata")
	// if err != nil {
	// 	panic(err)
	// }

	xmlFile, err := os.Open("metadata.xml")
	if err != nil {
		panic(err)
	}

	res, err := ioutil.ReadAll(xmlFile)
	if err != nil {
		panic(err)
	}

	metadata := &types.EntityDescriptor{}
	err = xml.Unmarshal(res, metadata)
	if err != nil {
		panic(err)
	}

	certStore := dsig.MemoryX509CertificateStore{
		Roots: []*x509.Certificate{},
	}

	for _, kd := range metadata.IDPSSODescriptor.KeyDescriptors {
		for idx, xcert := range kd.KeyInfo.X509Data.X509Certificates {
			if xcert.Data == "" {
				panic(fmt.Errorf("metadata certificate(%d) must not be empty", idx))
			}
			certData, err := base64.StdEncoding.DecodeString(xcert.Data)
			if err != nil {
				panic(err)
			}

			idpCert, err := x509.ParseCertificate(certData)
			if err != nil {
				panic(err)
			}

			certStore.Roots = append(certStore.Roots, idpCert)
		}
	}

	randomKeyStore := dsig.RandomKeyStoreForTest()

	sp := &saml2.SAMLServiceProvider{
		IdentityProviderSSOURL:      metadata.IDPSSODescriptor.SingleSignOnServices[0].Location,
		IdentityProviderIssuer:      metadata.EntityID,
		ServiceProviderIssuer:       "http://localhost:3001/msr/saml/metadata",
		AssertionConsumerServiceURL: "http://localhost:3001/msr/saml/auth",
		SignAuthnRequests:           true,
		AudienceURI:                 "http://localhost:3001/msr/saml/metadata",
		IDPCertificateStore:         &certStore,
		SPKeyStore:                  randomKeyStore,
	}

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		render(w, "views/login.html", nil)
	})

	authURL, err := sp.BuildAuthURL("")
	if err != nil {
		panic(err)
	}

	http.HandleFunc("/login", func(rw http.ResponseWriter, r *http.Request) {
		http.Redirect(rw, r, authURL, http.StatusFound)
	})

	http.HandleFunc("/msr/saml/auth", func(rw http.ResponseWriter, req *http.Request) {
		err := req.ParseForm()
		if err != nil {
			rw.WriteHeader(http.StatusBadRequest)
			return
		}

		samlResponse := ""
		if req.FormValue("SAMLResponse") != "" {
			samlResponse = req.FormValue("SAMLResponse")
		} else {
			samlResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOlJlc3BvbnNlIERlc3RpbmF0aW9uPSJodHRwOi8vbG9jYWxob3N0OjMwMDEvbXNyL3NhbWwvYXV0aCIgSUQ9ImlkMTMwMDExMjQ1MDUxMjAzNTUxMjI0MDgxNjk4IiBJblJlc3BvbnNlVG89Il82ZTZjZWNhYi1hYmRkLTRkYTMtYjk1NC1iYmIxMDE5NTc4NWUiIElzc3VlSW5zdGFudD0iMjAyMi0wMS0xN1QxMDozMjowOC4zODZaIiBWZXJzaW9uPSIyLjAiIHhtbG5zOnNhbWwycD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIiB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiPjxzYW1sMjpJc3N1ZXIgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDplbnRpdHkiIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj5odHRwOi8vd3d3Lm9rdGEuY29tL2V4azNsYW1tNG5USWsxY0ZLNWQ3PC9zYW1sMjpJc3N1ZXI+PGRzOlNpZ25hdHVyZSB4bWxuczpkcz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PGRzOlNpZ25lZEluZm8+PGRzOkNhbm9uaWNhbGl6YXRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIvPjxkczpSZWZlcmVuY2UgVVJJPSIjaWQxMzAwMTEyNDUwNTEyMDM1NTEyMjQwODE2OTgiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiPjxlYzpJbmNsdXNpdmVOYW1lc3BhY2VzIFByZWZpeExpc3Q9InhzIiB4bWxuczplYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PC9kczpUcmFuc2Zvcm0+PC9kczpUcmFuc2Zvcm1zPjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHM6RGlnZXN0VmFsdWU+OExGWDM5bytZNlhBdWlHY3duZVg1cC9YZHZSZnlkdkJnakc2ZVdiSU9jYz08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPjwvZHM6U2lnbmVkSW5mbz48ZHM6U2lnbmF0dXJlVmFsdWU+UTFVQmxNSFFELzNQdEpaUjRyanZqUHkvTGpMVXMyTU1vaEd4cjZwRmpLUXJ0Y25ZbktDVy93WG5lZDkvL3Q4b2pOaTJNZlhGT0VXdEJ2TzhLbGZTUjEvVkVSL0pZL3d5WWFTeXh0UlhtWjNBcHNWbVh3SEJiY1RWVlRwSnh6MmNld0pVaDcwSHRsdU9CUDgrbUQvVENlS3FCOGdiODdadEFVdExLZ0YwNmxZMy94akd1SVc2MHpzdGg4eXBCSGhGTlJBNklaQ3kzbkF2M1R6Y0N6aVIyYVNKaFd2SVR5aFJtMmlzVU1kYWh5WlJhc3p3VmJueHVFWVNqM1UxRkhNbkpod2VnOW43cmN2cy8vRmQxRlg3Q3pBUUxqcmdFb3Y5SXA0ZHNlekRRY2JVUjF5L29lUkVLSHVuWm5mZmZxMXZhVDB5VGs1Z0xHbWQ2QmsySTV1dS9nPT08L2RzOlNpZ25hdHVyZVZhbHVlPjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSURwakNDQW82Z0F3SUJBZ0lHQVg1U09UT1pNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1JR1RNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUcKQTFVRUNBd0tRMkZzYVdadmNtNXBZVEVXTUJRR0ExVUVCd3dOVTJGdUlFWnlZVzVqYVhOamJ6RU5NQXNHQTFVRUNnd0VUMnQwWVRFVQpNQklHQTFVRUN3d0xVMU5QVUhKdmRtbGtaWEl4RkRBU0JnTlZCQU1NQzJSbGRpMDVOemc0TkRBeU1Sd3dHZ1lKS29aSWh2Y05BUWtCCkZnMXBibVp2UUc5cmRHRXVZMjl0TUI0WERUSXlNREV4TXpBMk5UVXlOMW9YRFRNeU1ERXhNekEyTlRZeU4xb3dnWk14Q3pBSkJnTlYKQkFZVEFsVlRNUk13RVFZRFZRUUlEQXBEWVd4cFptOXlibWxoTVJZd0ZBWURWUVFIREExVFlXNGdSbkpoYm1OcGMyTnZNUTB3Q3dZRApWUVFLREFSUGEzUmhNUlF3RWdZRFZRUUxEQXRUVTA5UWNtOTJhV1JsY2pFVU1CSUdBMVVFQXd3TFpHVjJMVGszT0RnME1ESXhIREFhCkJna3Foa2lHOXcwQkNRRVdEV2x1Wm05QWIydDBZUzVqYjIwd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUIKQVFDTE9KbFMyWmthN2tYV2dwQWtCOWRNaVZPSzRiT3dPRXJySDFmMjFKU3BNcVNPMk5nQVRnVUJkeUpaNy9DSTVLT3BlSTdGZW1QawpCeEFWSDhSbzlmRXVHRFNlbTRKZGJIb0xKY0Rsb1hTaklXNitDQm9Nald4Z2NkVkxMWkJGYnpMVVpJbW5hNkt5QlU4TktyWlFKV0FyCldiZzVRR0hUbGR0dUh4UndtSE5ZNWFoV1VQR1I3cHZlK0hDNkFlU2lSQkhDZUFqZnlWQ0srcUpZLzJNTGpFK2hqMlVsSSt4dnBxUkcKMHRuRXlkWlFnN1VqZ2JmeFRmZVV3RnJ2Y25ybkFoVkNTbkQzZVdtM0l1WFVDbzhMZGxxekRoRUJ5YmduN0pOUCtuQ3VsOVdOd1FHQQpQVkFld2R4V3F5Nmh4cGZ5SDJVVjZYTmZXdUI0b0FqR2VudjRwK1pSQWdNQkFBRXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSFZWCk5ud25GMEgwM05nL3RqdGg4WVRwMTF1YUx6OU9ldWVITlJLYVY1Zzk4eExtZldpOC9XV1p4MjhXeHB2Sm9TVnpPT21Uekw5Nk1GWGoKdkFXOXZhTzloV1FoYnhTMEk4SWhNczVUT0V2RzRON1JPclNyK3RSQkh3N3RDRkpteFJJQTFkSlVNT3crK2FDbkRxL1NXR3NCZFlLeAp2NUVlUEU5UlhNN3FEUUpxVTJVMkNsY2RpSTJSVXR6Wm10dHp5aVRFRVpKNWdRU0tFUmtjR0xYd0R0bXBKc0M0NzY2UEFIVFViaGY4CmRzbmFxUFZtOSt4WGlQSzYwV3NTOEpGUEZCN3l2a29XZkJDaTIyUVJsYnJBTWNwd09TcTJPOFlZUkw5Z2dhVlFoREFVeU4ya3FMKzIKMWZnZ2FrNHA3NTRWd2s2cGRadmhKSVJQakdlc0ZXOTJIUlE9PC9kczpYNTA5Q2VydGlmaWNhdGU+PC9kczpYNTA5RGF0YT48L2RzOktleUluZm8+PC9kczpTaWduYXR1cmU+PHNhbWwycDpTdGF0dXMgeG1sbnM6c2FtbDJwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiPjxzYW1sMnA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1sMnA6U3RhdHVzPjxzYW1sMjpBc3NlcnRpb24gSUQ9ImlkMTMwMDExMjQ1MDUyMDc0MDYxNjYzNjQyMDIwIiBJc3N1ZUluc3RhbnQ9IjIwMjItMDEtMTdUMTA6MzI6MDguMzg2WiIgVmVyc2lvbj0iMi4wIiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiIgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIj48c2FtbDI6SXNzdWVyIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5IiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+aHR0cDovL3d3dy5va3RhLmNvbS9leGszbGFtbTRuVElrMWNGSzVkNzwvc2FtbDI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI2lkMTMwMDExMjQ1MDUyMDc0MDYxNjYzNjQyMDIwIj48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIj48ZWM6SW5jbHVzaXZlTmFtZXNwYWNlcyBQcmVmaXhMaXN0PSJ4cyIgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3JtPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPjkrSUpiUmo1eHIvSUIwNXE1bUNrSjJUUDlEaDJzK09OWGJONThiL053WGs9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8+PGRzOlNpZ25hdHVyZVZhbHVlPmdzaUR1emREckp6bEJXV0Q5RVQ0cFJ6L0Y2elZ6RDRPYnN5d1J3K0FieUY1UVNHUmtQTGtSTXFiYlU0ZmZ6bStBMjRUb3VVeU5qNGd3K3ZxV1BkNGN2YlUvTGp1bWxWMlY1dFgrVS9LZGZBQlo3Wmc2d0lCS0JURWw0QiszZmdrUUEwbjc4OVhmTWhISndtaUpiYTI1bnM1RzZXdWxweEp5bmM4ejJ3b211UmpqeUplZFpYMFNVUm0xUElSajdFY2NzbTlvVXVzeGZtZTAyV2xiR1ArOVZLeDRBSHpRVE9UVzZwanM1eE5MbzBnRWI3Zkh6QlkrRzhjTFJtdGkyNGQ1MGJ5T1o4VWVMdXZwMUlKalFHYTlWMnZENWJSVmNlTHRZTy8wT2txaENzSEhFRlEyOFk4dGNHVDRuVm9hS3NqV2dIelRjTGhhYlRqeEJUZmFMS0ZIQT09PC9kczpTaWduYXR1cmVWYWx1ZT48ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlEcGpDQ0FvNmdBd0lCQWdJR0FYNVNPVE9aTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdUTVFzd0NRWURWUVFHRXdKVlV6RVRNQkVHCkExVUVDQXdLUTJGc2FXWnZjbTVwWVRFV01CUUdBMVVFQnd3TlUyRnVJRVp5WVc1amFYTmpiekVOTUFzR0ExVUVDZ3dFVDJ0MFlURVUKTUJJR0ExVUVDd3dMVTFOUFVISnZkbWxrWlhJeEZEQVNCZ05WQkFNTUMyUmxkaTA1TnpnNE5EQXlNUnd3R2dZSktvWklodmNOQVFrQgpGZzFwYm1adlFHOXJkR0V1WTI5dE1CNFhEVEl5TURFeE16QTJOVFV5TjFvWERUTXlNREV4TXpBMk5UWXlOMW93Z1pNeEN6QUpCZ05WCkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJtTnBjMk52TVEwd0N3WUQKVlFRS0RBUlBhM1JoTVJRd0VnWURWUVFMREF0VFUwOVFjbTkyYVdSbGNqRVVNQklHQTFVRUF3d0xaR1YyTFRrM09EZzBNREl4SERBYQpCZ2txaGtpRzl3MEJDUUVXRFdsdVptOUFiMnQwWVM1amIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRQ0xPSmxTMlprYTdrWFdncEFrQjlkTWlWT0s0Yk93T0VyckgxZjIxSlNwTXFTTzJOZ0FUZ1VCZHlKWjcvQ0k1S09wZUk3RmVtUGsKQnhBVkg4Um85ZkV1R0RTZW00SmRiSG9MSmNEbG9YU2pJVzYrQ0JvTWpXeGdjZFZMTFpCRmJ6TFVaSW1uYTZLeUJVOE5LclpRSldBcgpXYmc1UUdIVGxkdHVIeFJ3bUhOWTVhaFdVUEdSN3B2ZStIQzZBZVNpUkJIQ2VBamZ5VkNLK3FKWS8yTUxqRStoajJVbEkreHZwcVJHCjB0bkV5ZFpRZzdVamdiZnhUZmVVd0ZydmNucm5BaFZDU25EM2VXbTNJdVhVQ284TGRscXpEaEVCeWJnbjdKTlArbkN1bDlXTndRR0EKUFZBZXdkeFdxeTZoeHBmeUgyVVY2WE5mV3VCNG9BakdlbnY0cCtaUkFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUhWVgpObnduRjBIMDNOZy90anRoOFlUcDExdWFMejlPZXVlSE5SS2FWNWc5OHhMbWZXaTgvV1daeDI4V3hwdkpvU1Z6T09tVHpMOTZNRlhqCnZBVzl2YU85aFdRaGJ4UzBJOEloTXM1VE9Fdkc0TjdST3JTcit0UkJIdzd0Q0ZKbXhSSUExZEpVTU93KythQ25EcS9TV0dzQmRZS3gKdjVFZVBFOVJYTTdxRFFKcVUyVTJDbGNkaUkyUlV0elptdHR6eWlURUVaSjVnUVNLRVJrY0dMWHdEdG1wSnNDNDc2NlBBSFRVYmhmOApkc25hcVBWbTkreFhpUEs2MFdzUzhKRlBGQjd5dmtvV2ZCQ2kyMlFSbGJyQU1jcHdPU3EyTzhZWVJMOWdnYVZRaERBVXlOMmtxTCsyCjFmZ2dhazRwNzU0VndrNnBkWnZoSklSUGpHZXNGVzkySFJRPTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sMjpTdWJqZWN0IHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6TmFtZUlEIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4xOm5hbWVpZC1mb3JtYXQ6dW5zcGVjaWZpZWQiPnRob25nZG0yQHZpZXR0ZWwuY29tLnZuPC9zYW1sMjpOYW1lSUQ+PHNhbWwyOlN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48c2FtbDI6U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgSW5SZXNwb25zZVRvPSJfNmU2Y2VjYWItYWJkZC00ZGEzLWI5NTQtYmJiMTAxOTU3ODVlIiBOb3RPbk9yQWZ0ZXI9IjIwMjItMDEtMTdUMTA6Mzc6MDguMzg2WiIgUmVjaXBpZW50PSJodHRwOi8vbG9jYWxob3N0OjMwMDEvbXNyL3NhbWwvYXV0aCIvPjwvc2FtbDI6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWwyOlN1YmplY3Q+PHNhbWwyOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDIyLTAxLTE3VDEwOjI3OjA4LjM4NloiIE5vdE9uT3JBZnRlcj0iMjAyMi0wMS0xN1QxMDozNzowOC4zODZaIiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWwyOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWwyOkF1ZGllbmNlPmh0dHA6Ly9sb2NhbGhvc3Q6MzAwMS9tc3Ivc2FtbC9tZXRhZGF0YTwvc2FtbDI6QXVkaWVuY2U+PC9zYW1sMjpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDI6Q29uZGl0aW9ucz48c2FtbDI6QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDIyLTAxLTE3VDEwOjMyOjA4LjM4NloiIFNlc3Npb25JbmRleD0iXzZlNmNlY2FiLWFiZGQtNGRhMy1iOTU0LWJiYjEwMTk1Nzg1ZSIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sMjpBdXRobkNvbnRleHQ+PHNhbWwyOkF1dGhuQ29udGV4dENsYXNzUmVmPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOlBhc3N3b3JkUHJvdGVjdGVkVHJhbnNwb3J0PC9zYW1sMjpBdXRobkNvbnRleHRDbGFzc1JlZj48L3NhbWwyOkF1dGhuQ29udGV4dD48L3NhbWwyOkF1dGhuU3RhdGVtZW50PjxzYW1sMjpBdHRyaWJ1dGVTdGF0ZW1lbnQgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sMjpBdHRyaWJ1dGUgTmFtZT0iRmlyc3QgbmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI+PHNhbWwyOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+VGhvbmc8L3NhbWwyOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDI6QXR0cmlidXRlPjxzYW1sMjpBdHRyaWJ1dGUgTmFtZT0iTGFzdCBuYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj48c2FtbDI6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5Ebzwvc2FtbDI6QXR0cmlidXRlVmFsdWU+PC9zYW1sMjpBdHRyaWJ1dGU+PHNhbWwyOkF0dHJpYnV0ZSBOYW1lPSJFbWFpbCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI+PHNhbWwyOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dGhvbmdkbTJAdmlldHRlbC5jb20udm48L3NhbWwyOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDI6QXR0cmlidXRlPjxzYW1sMjpBdHRyaWJ1dGUgTmFtZT0iTG9naW4iIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dW5zcGVjaWZpZWQiPjxzYW1sMjpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnRob25nZG0yQHZpZXR0ZWwuY29tLnZuPC9zYW1sMjpBdHRyaWJ1dGVWYWx1ZT48L3NhbWwyOkF0dHJpYnV0ZT48L3NhbWwyOkF0dHJpYnV0ZVN0YXRlbWVudD48L3NhbWwyOkFzc2VydGlvbj48L3NhbWwycDpSZXNwb25zZT4="
		}

		assertionInfo, err := sp.RetrieveAssertionInfo(samlResponse)
		if err != nil {
			fmt.Printf("assertion err: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.InvalidTime {
			fmt.Printf("Invalid time: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.NotInAudience {
			fmt.Printf("Not in audience: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		fmt.Fprintf(rw, "NameID: %s\n", assertionInfo.NameID)

		fmt.Fprintf(rw, "Assertions:\n")

		for key, val := range assertionInfo.Values {
			fmt.Fprintf(rw, "  %s: %+v\n", key, val)
		}

		fmt.Fprintf(rw, "\n")

		fmt.Fprintf(rw, "Warnings:\n")
		fmt.Fprintf(rw, "%+v\n", assertionInfo.WarningInfo)
	})

	// println("Visit this URL To Authenticate:")

	// println(authURL)

	// println("Supply:")
	// fmt.Printf("  SP ACS URL      : %s\n", sp.AssertionConsumerServiceURL)

	err = http.ListenAndServe(":3001", nil)
	if err != nil {
		panic(err)
	}
}

func render(w http.ResponseWriter, path string, data interface{}) {
	w.Header().Set("Content-Type", "text/html")
	w.Header().Set("Cache-Control", "no-store")
	w.Header().Set("Pragma", "no-cache")
	w.WriteHeader(http.StatusOK)
	tlp := template.Must(template.ParseFiles(path))
	tlp.Execute(w, data)
}
