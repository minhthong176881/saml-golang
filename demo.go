package main

import (
	"crypto/x509"
	"fmt"
	"html/template"
	"net/http"
	"os"

	"io/ioutil"

	"encoding/base64"
	"encoding/xml"

	saml2 "github.com/russellhaering/gosaml2"
	"github.com/russellhaering/gosaml2/types"
	dsig "github.com/russellhaering/goxmldsig"
)

func main() {
	// res, err := http.Get("https://dev-9788402.okta.com/app/exk3lamm4nTIk1cFK5d7/sso/saml/metadata")
	// if err != nil {
	// 	panic(err)
	// }

	xmlFile, err := os.Open("metadata.xml")
	if err != nil {
		panic(err)
	}

	res, err := ioutil.ReadAll(xmlFile)
	if err != nil {
		panic(err)
	}

	metadata := &types.EntityDescriptor{}
	err = xml.Unmarshal(res, metadata)
	if err != nil {
		panic(err)
	}

	certStore := dsig.MemoryX509CertificateStore{
		Roots: []*x509.Certificate{},
	}

	for _, kd := range metadata.IDPSSODescriptor.KeyDescriptors {
		for idx, xcert := range kd.KeyInfo.X509Data.X509Certificates {
			if xcert.Data == "" {
				panic(fmt.Errorf("metadata certificate(%d) must not be empty", idx))
			}
			certData, err := base64.StdEncoding.DecodeString(xcert.Data)
			if err != nil {
				panic(err)
			}

			idpCert, err := x509.ParseCertificate(certData)
			if err != nil {
				panic(err)
			}

			certStore.Roots = append(certStore.Roots, idpCert)
		}
	}

	randomKeyStore := dsig.RandomKeyStoreForTest()

	sp := &saml2.SAMLServiceProvider{
		IdentityProviderSSOURL:      metadata.IDPSSODescriptor.SingleSignOnServices[0].Location,
		IdentityProviderIssuer:      metadata.EntityID,
		ServiceProviderIssuer:       "http://localhost:3001/msr/saml/metadata",
		AssertionConsumerServiceURL: "http://localhost:3001/msr/saml/auth",
		SignAuthnRequests:           true,
		AudienceURI:                 "http://localhost:3001/msr/saml/metadata",
		IDPCertificateStore:         &certStore,
		SPKeyStore:                  randomKeyStore,
	}

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		render(w, "views/login.html", nil)
	})

	authURL, err := sp.BuildAuthURL("")
	if err != nil {
		panic(err)
	}

	http.HandleFunc("/login", func(rw http.ResponseWriter, r *http.Request) {
		http.Redirect(rw, r, authURL, http.StatusFound)
	})

	http.HandleFunc("/msr/saml/auth", func(rw http.ResponseWriter, req *http.Request) {
		err := req.ParseForm()
		if err != nil {
			rw.WriteHeader(http.StatusBadRequest)
			return
		}

		samlResponse := ""
		if req.FormValue("SAMLResponse") != "" {
			samlResponse = req.FormValue("SAMLResponse")
		} else {
			samlResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOlJlc3BvbnNlIERlc3RpbmF0aW9uPSJodHRwOi8vbG9jYWxob3N0OjMwMDEvbXNyL3NhbWwvYXV0aCIgSUQ9ImlkMTI5OTY4NjUxMDUzOTc0ODU3Njk1NzQ3OTUiIEluUmVzcG9uc2VUbz0iXzgwYTc5Y2YyLWI0ZjYtNDI0My05ZDkxLTI5NGI4MTA4MWFhNyIgSXNzdWVJbnN0YW50PSIyMDIyLTAxLTE3VDA5OjE1OjEwLjk0NloiIFZlcnNpb249IjIuMCIgeG1sbnM6c2FtbDJwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSI+PHNhbWwyOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly93d3cub2t0YS5jb20vZXhrM2xhbW00blRJazFjRks1ZDc8L3NhbWwyOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzOlJlZmVyZW5jZSBVUkk9IiNpZDEyOTk2ODY1MTA1Mzk3NDg1NzY5NTc0Nzk1Ij48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIj48ZWM6SW5jbHVzaXZlTmFtZXNwYWNlcyBQcmVmaXhMaXN0PSJ4cyIgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3JtPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPk1ZbFZ4ZG10dEs4TGRzMk9jRVpXSUdiZXdydDJvaG10bUJ4YWdzRzNVNjg9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8+PGRzOlNpZ25hdHVyZVZhbHVlPkQ1YWdtVzJCcDdZQnFKdDJ1WG56Ri80Z0VraFFVMHBSZlVXSTQxUFdjYTFjYmVGZnZxNTVzVG9lMVpwK1ZOTll1WU80VmVCT0wrcjdETjFWdHVyMkxzNytvK0trZ0pTbVBJZTJYbHowOVlTdE9LL0NXMm9oQWNrMkcvb0M4Tlg2MUdGcEtRZ2pFK016a1htZ3VNaVBoNDFVakpocXVQbmtSSVpkVkZrbTZvL0hBOFpGRmFERlluZ1pWcUorRGdwdDVncEpWZ3pGazV1TjdIdlFPcmlrZnR0NkhvUnJnOFc1MGUyRlY3YlhNZWY0SmV3WVc1b214MVBBSnRjZEVxVWRHeksvTmw5ZGwxR1QvWUVsb1NLeGwyRGI1eWZTcGhibCtLNnp4RDZ6aDNDOEV5YzBGYytZTUMxZFJ6aGdTNHdNc3k2dDhJNlRaK25Qem1kS28xMDdCZz09PC9kczpTaWduYXR1cmVWYWx1ZT48ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlEcGpDQ0FvNmdBd0lCQWdJR0FYNVNPVE9aTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdUTVFzd0NRWURWUVFHRXdKVlV6RVRNQkVHCkExVUVDQXdLUTJGc2FXWnZjbTVwWVRFV01CUUdBMVVFQnd3TlUyRnVJRVp5WVc1amFYTmpiekVOTUFzR0ExVUVDZ3dFVDJ0MFlURVUKTUJJR0ExVUVDd3dMVTFOUFVISnZkbWxrWlhJeEZEQVNCZ05WQkFNTUMyUmxkaTA1TnpnNE5EQXlNUnd3R2dZSktvWklodmNOQVFrQgpGZzFwYm1adlFHOXJkR0V1WTI5dE1CNFhEVEl5TURFeE16QTJOVFV5TjFvWERUTXlNREV4TXpBMk5UWXlOMW93Z1pNeEN6QUpCZ05WCkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJtTnBjMk52TVEwd0N3WUQKVlFRS0RBUlBhM1JoTVJRd0VnWURWUVFMREF0VFUwOVFjbTkyYVdSbGNqRVVNQklHQTFVRUF3d0xaR1YyTFRrM09EZzBNREl4SERBYQpCZ2txaGtpRzl3MEJDUUVXRFdsdVptOUFiMnQwWVM1amIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRQ0xPSmxTMlprYTdrWFdncEFrQjlkTWlWT0s0Yk93T0VyckgxZjIxSlNwTXFTTzJOZ0FUZ1VCZHlKWjcvQ0k1S09wZUk3RmVtUGsKQnhBVkg4Um85ZkV1R0RTZW00SmRiSG9MSmNEbG9YU2pJVzYrQ0JvTWpXeGdjZFZMTFpCRmJ6TFVaSW1uYTZLeUJVOE5LclpRSldBcgpXYmc1UUdIVGxkdHVIeFJ3bUhOWTVhaFdVUEdSN3B2ZStIQzZBZVNpUkJIQ2VBamZ5VkNLK3FKWS8yTUxqRStoajJVbEkreHZwcVJHCjB0bkV5ZFpRZzdVamdiZnhUZmVVd0ZydmNucm5BaFZDU25EM2VXbTNJdVhVQ284TGRscXpEaEVCeWJnbjdKTlArbkN1bDlXTndRR0EKUFZBZXdkeFdxeTZoeHBmeUgyVVY2WE5mV3VCNG9BakdlbnY0cCtaUkFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUhWVgpObnduRjBIMDNOZy90anRoOFlUcDExdWFMejlPZXVlSE5SS2FWNWc5OHhMbWZXaTgvV1daeDI4V3hwdkpvU1Z6T09tVHpMOTZNRlhqCnZBVzl2YU85aFdRaGJ4UzBJOEloTXM1VE9Fdkc0TjdST3JTcit0UkJIdzd0Q0ZKbXhSSUExZEpVTU93KythQ25EcS9TV0dzQmRZS3gKdjVFZVBFOVJYTTdxRFFKcVUyVTJDbGNkaUkyUlV0elptdHR6eWlURUVaSjVnUVNLRVJrY0dMWHdEdG1wSnNDNDc2NlBBSFRVYmhmOApkc25hcVBWbTkreFhpUEs2MFdzUzhKRlBGQjd5dmtvV2ZCQ2kyMlFSbGJyQU1jcHdPU3EyTzhZWVJMOWdnYVZRaERBVXlOMmtxTCsyCjFmZ2dhazRwNzU0VndrNnBkWnZoSklSUGpHZXNGVzkySFJRPTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sMnA6U3RhdHVzIHhtbG5zOnNhbWwycD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIj48c2FtbDJwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvc2FtbDJwOlN0YXR1cz48c2FtbDI6QXNzZXJ0aW9uIElEPSJpZDEyOTk2ODY1MTA1NDc0NjEwNjc0OTYzNTU2IiBJc3N1ZUluc3RhbnQ9IjIwMjItMDEtMTdUMDk6MTU6MTAuOTQ2WiIgVmVyc2lvbj0iMi4wIiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiIgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIj48c2FtbDI6SXNzdWVyIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5IiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+aHR0cDovL3d3dy5va3RhLmNvbS9leGszbGFtbTRuVElrMWNGSzVkNzwvc2FtbDI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI2lkMTI5OTY4NjUxMDU0NzQ2MTA2NzQ5NjM1NTYiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiPjxlYzpJbmNsdXNpdmVOYW1lc3BhY2VzIFByZWZpeExpc3Q9InhzIiB4bWxuczplYz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PC9kczpUcmFuc2Zvcm0+PC9kczpUcmFuc2Zvcm1zPjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHM6RGlnZXN0VmFsdWU+bnR5cjZQT1ZzYndYOENXdlNuR2VXRUdQblNybnFNZ2QrRjk4RThtT3Y1OD08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPjwvZHM6U2lnbmVkSW5mbz48ZHM6U2lnbmF0dXJlVmFsdWU+ZXljSXJ1UTBPRXhsL1I4OFova0hKYVBndDY2QlN2dUJoQTgveWdYUGZaMUZqbER1a1ZSVStpb2owWjlzMmQyQzVTbStWdmYxQzBuMTZWUWtzWWEwa1dIVEdwMzgxcnFUSDBNUnBmd21HanpFUG5qdkxxcnpDcFJHSTJIUUZPZWJpWkVSMmVmVlB0bXZEemJlL1J3czBmZlpBWndNc2RTWnpyUW01YmpNSGpGRUtNVjMwdURtVWpjbnM5ZmgxajdiejlaVzZnS3B0YmNFVGYyMzExUllicFJNVjBtay9mQndaRGJzcHora04zU2pYUncxVFFEd0NzVzcrMldXS3A4eURNNTE3UEhyWHNJUHdaQTZLeVpydVoybzg5SDluSWFNNU5COTFabUxKWjduT3IyM3lLWHFESGlhSkFlVXRBZ044cnZYSGd5MWNNZFM4ejE3cHBkaWt3PT08L2RzOlNpZ25hdHVyZVZhbHVlPjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSURwakNDQW82Z0F3SUJBZ0lHQVg1U09UT1pNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1JR1RNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUcKQTFVRUNBd0tRMkZzYVdadmNtNXBZVEVXTUJRR0ExVUVCd3dOVTJGdUlFWnlZVzVqYVhOamJ6RU5NQXNHQTFVRUNnd0VUMnQwWVRFVQpNQklHQTFVRUN3d0xVMU5QVUhKdmRtbGtaWEl4RkRBU0JnTlZCQU1NQzJSbGRpMDVOemc0TkRBeU1Sd3dHZ1lKS29aSWh2Y05BUWtCCkZnMXBibVp2UUc5cmRHRXVZMjl0TUI0WERUSXlNREV4TXpBMk5UVXlOMW9YRFRNeU1ERXhNekEyTlRZeU4xb3dnWk14Q3pBSkJnTlYKQkFZVEFsVlRNUk13RVFZRFZRUUlEQXBEWVd4cFptOXlibWxoTVJZd0ZBWURWUVFIREExVFlXNGdSbkpoYm1OcGMyTnZNUTB3Q3dZRApWUVFLREFSUGEzUmhNUlF3RWdZRFZRUUxEQXRUVTA5UWNtOTJhV1JsY2pFVU1CSUdBMVVFQXd3TFpHVjJMVGszT0RnME1ESXhIREFhCkJna3Foa2lHOXcwQkNRRVdEV2x1Wm05QWIydDBZUzVqYjIwd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUIKQVFDTE9KbFMyWmthN2tYV2dwQWtCOWRNaVZPSzRiT3dPRXJySDFmMjFKU3BNcVNPMk5nQVRnVUJkeUpaNy9DSTVLT3BlSTdGZW1QawpCeEFWSDhSbzlmRXVHRFNlbTRKZGJIb0xKY0Rsb1hTaklXNitDQm9Nald4Z2NkVkxMWkJGYnpMVVpJbW5hNkt5QlU4TktyWlFKV0FyCldiZzVRR0hUbGR0dUh4UndtSE5ZNWFoV1VQR1I3cHZlK0hDNkFlU2lSQkhDZUFqZnlWQ0srcUpZLzJNTGpFK2hqMlVsSSt4dnBxUkcKMHRuRXlkWlFnN1VqZ2JmeFRmZVV3RnJ2Y25ybkFoVkNTbkQzZVdtM0l1WFVDbzhMZGxxekRoRUJ5YmduN0pOUCtuQ3VsOVdOd1FHQQpQVkFld2R4V3F5Nmh4cGZ5SDJVVjZYTmZXdUI0b0FqR2VudjRwK1pSQWdNQkFBRXdEUVlKS29aSWh2Y05BUUVMQlFBRGdnRUJBSFZWCk5ud25GMEgwM05nL3RqdGg4WVRwMTF1YUx6OU9ldWVITlJLYVY1Zzk4eExtZldpOC9XV1p4MjhXeHB2Sm9TVnpPT21Uekw5Nk1GWGoKdkFXOXZhTzloV1FoYnhTMEk4SWhNczVUT0V2RzRON1JPclNyK3RSQkh3N3RDRkpteFJJQTFkSlVNT3crK2FDbkRxL1NXR3NCZFlLeAp2NUVlUEU5UlhNN3FEUUpxVTJVMkNsY2RpSTJSVXR6Wm10dHp5aVRFRVpKNWdRU0tFUmtjR0xYd0R0bXBKc0M0NzY2UEFIVFViaGY4CmRzbmFxUFZtOSt4WGlQSzYwV3NTOEpGUEZCN3l2a29XZkJDaTIyUVJsYnJBTWNwd09TcTJPOFlZUkw5Z2dhVlFoREFVeU4ya3FMKzIKMWZnZ2FrNHA3NTRWd2s2cGRadmhKSVJQakdlc0ZXOTJIUlE9PC9kczpYNTA5Q2VydGlmaWNhdGU+PC9kczpYNTA5RGF0YT48L2RzOktleUluZm8+PC9kczpTaWduYXR1cmU+PHNhbWwyOlN1YmplY3QgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sMjpOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoxLjE6bmFtZWlkLWZvcm1hdDp1bnNwZWNpZmllZCI+dGhvbmdkbTJAdmlldHRlbC5jb20udm48L3NhbWwyOk5hbWVJRD48c2FtbDI6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPjxzYW1sMjpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBJblJlc3BvbnNlVG89Il84MGE3OWNmMi1iNGY2LTQyNDMtOWQ5MS0yOTRiODEwODFhYTciIE5vdE9uT3JBZnRlcj0iMjAyMi0wMS0xN1QwOToyMDoxMC45NDZaIiBSZWNpcGllbnQ9Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMS9tc3Ivc2FtbC9hdXRoIi8+PC9zYW1sMjpTdWJqZWN0Q29uZmlybWF0aW9uPjwvc2FtbDI6U3ViamVjdD48c2FtbDI6Q29uZGl0aW9ucyBOb3RCZWZvcmU9IjIwMjItMDEtMTdUMDk6MTA6MTAuOTQ2WiIgTm90T25PckFmdGVyPSIyMDIyLTAxLTE3VDA5OjIwOjEwLjk0NloiIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6QXVkaWVuY2VSZXN0cmljdGlvbj48c2FtbDI6QXVkaWVuY2U+aHR0cDovL2xvY2FsaG9zdDozMDAxL21zci9zYW1sL21ldGFkYXRhPC9zYW1sMjpBdWRpZW5jZT48L3NhbWwyOkF1ZGllbmNlUmVzdHJpY3Rpb24+PC9zYW1sMjpDb25kaXRpb25zPjxzYW1sMjpBdXRoblN0YXRlbWVudCBBdXRobkluc3RhbnQ9IjIwMjItMDEtMTdUMDk6MTU6MTAuOTQ2WiIgU2Vzc2lvbkluZGV4PSJfODBhNzljZjItYjRmNi00MjQzLTlkOTEtMjk0YjgxMDgxYWE3IiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWwyOkF1dGhuQ29udGV4dD48c2FtbDI6QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L3NhbWwyOkF1dGhuQ29udGV4dENsYXNzUmVmPjwvc2FtbDI6QXV0aG5Db250ZXh0Pjwvc2FtbDI6QXV0aG5TdGF0ZW1lbnQ+PHNhbWwyOkF0dHJpYnV0ZVN0YXRlbWVudCB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWwyOkF0dHJpYnV0ZSBOYW1lPSJGaXJzdCBuYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj48c2FtbDI6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj5UaG9uZzwvc2FtbDI6QXR0cmlidXRlVmFsdWU+PC9zYW1sMjpBdHRyaWJ1dGU+PHNhbWwyOkF0dHJpYnV0ZSBOYW1lPSJMYXN0IG5hbWUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dW5zcGVjaWZpZWQiPjxzYW1sMjpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPkRvPC9zYW1sMjpBdHRyaWJ1dGVWYWx1ZT48L3NhbWwyOkF0dHJpYnV0ZT48c2FtbDI6QXR0cmlidXRlIE5hbWU9IkVtYWlsIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj48c2FtbDI6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj50aG9uZ2RtMkB2aWV0dGVsLmNvbS52bjwvc2FtbDI6QXR0cmlidXRlVmFsdWU+PC9zYW1sMjpBdHRyaWJ1dGU+PHNhbWwyOkF0dHJpYnV0ZSBOYW1lPSJMb2dpbiIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI+PHNhbWwyOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dGhvbmdkbTJAdmlldHRlbC5jb20udm48L3NhbWwyOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDI6QXR0cmlidXRlPjwvc2FtbDI6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDI6QXNzZXJ0aW9uPjwvc2FtbDJwOlJlc3BvbnNlPg=="
		}

		assertionInfo, err := sp.RetrieveAssertionInfo(samlResponse)
		if err != nil {
			fmt.Printf("assertion err: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.InvalidTime {
			fmt.Printf("Invalid time: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.NotInAudience {
			fmt.Printf("Not in audience: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		fmt.Fprintf(rw, "NameID: %s\n", assertionInfo.NameID)

		fmt.Fprintf(rw, "Assertions:\n")

		for key, val := range assertionInfo.Values {
			fmt.Fprintf(rw, "  %s: %+v\n", key, val)
		}

		fmt.Fprintf(rw, "\n")

		fmt.Fprintf(rw, "Warnings:\n")
		fmt.Fprintf(rw, "%+v\n", assertionInfo.WarningInfo)
	})

	// println("Visit this URL To Authenticate:")

	// println(authURL)

	// println("Supply:")
	// fmt.Printf("  SP ACS URL      : %s\n", sp.AssertionConsumerServiceURL)

	err = http.ListenAndServe(":3001", nil)
	if err != nil {
		panic(err)
	}
}

func render(w http.ResponseWriter, path string, data interface{}) {
	w.Header().Set("Content-Type", "text/html")
	w.Header().Set("Cache-Control", "no-store")
	w.Header().Set("Pragma", "no-cache")
	w.WriteHeader(http.StatusOK)
	tlp := template.Must(template.ParseFiles(path))
	tlp.Execute(w, data)
}
