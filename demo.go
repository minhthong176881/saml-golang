package main

import (
	"crypto/x509"
	"fmt"
	"html/template"
	"net/http"
	"os"

	"io/ioutil"

	"encoding/base64"
	"encoding/xml"

	saml2 "github.com/russellhaering/gosaml2"
	"github.com/russellhaering/gosaml2/types"
	dsig "github.com/russellhaering/goxmldsig"
)

func main() {
	// res, err := http.Get("https://dev-9788402.okta.com/app/exk3lamm4nTIk1cFK5d7/sso/saml/metadata")
	// if err != nil {
	// 	panic(err)
	// }

	xmlFile, err := os.Open("metadata.xml")
	if err != nil {
		panic(err)
	}

	res, err := ioutil.ReadAll(xmlFile)
	if err != nil {
		panic(err)
	}

	metadata := &types.EntityDescriptor{}
	err = xml.Unmarshal(res, metadata)
	if err != nil {
		panic(err)
	}

	certStore := dsig.MemoryX509CertificateStore{
		Roots: []*x509.Certificate{},
	}

	for _, kd := range metadata.IDPSSODescriptor.KeyDescriptors {
		for idx, xcert := range kd.KeyInfo.X509Data.X509Certificates {
			if xcert.Data == "" {
				panic(fmt.Errorf("metadata certificate(%d) must not be empty", idx))
			}
			certData, err := base64.StdEncoding.DecodeString(xcert.Data)
			if err != nil {
				panic(err)
			}

			idpCert, err := x509.ParseCertificate(certData)
			if err != nil {
				panic(err)
			}

			certStore.Roots = append(certStore.Roots, idpCert)
		}
	}

	randomKeyStore := dsig.RandomKeyStoreForTest()

	sp := &saml2.SAMLServiceProvider{
		IdentityProviderSSOURL:      metadata.IDPSSODescriptor.SingleSignOnServices[0].Location,
		IdentityProviderIssuer:      metadata.EntityID,
		ServiceProviderIssuer:       "http://localhost:3001/msr/saml/metadata",
		AssertionConsumerServiceURL: "http://localhost:3001/msr/saml/auth",
		SignAuthnRequests:           true,
		AudienceURI:                 "http://localhost:3001/msr/saml/metadata",
		IDPCertificateStore:         &certStore,
		SPKeyStore:                  randomKeyStore,
	}

	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		render(w, "views/login.html", nil)
	})

	authURL, err := sp.BuildAuthURL("")
	if err != nil {
		panic(err)
	}

	http.HandleFunc("/login", func(rw http.ResponseWriter, r *http.Request) {
		http.Redirect(rw, r, authURL, http.StatusFound)
	})

	http.HandleFunc("/msr/saml/auth", func(rw http.ResponseWriter, req *http.Request) {
		err := req.ParseForm()
		if err != nil {
			rw.WriteHeader(http.StatusBadRequest)
			return
		}

		samlResponse := ""
		if req.FormValue("SAMLResponse") != "" {
			samlResponse = req.FormValue("SAMLResponse")
		} else {
			samlResponse = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOlJlc3BvbnNlIERlc3RpbmF0aW9uPSJodHRwOi8vbG9jYWxob3N0OjMwMDEvbXNyL3NhbWwvYXV0aCIgSUQ9ImlkMTMwMDQ1Njg0ODkwNjQxNTU3MTcxMjQ3NzkiIEluUmVzcG9uc2VUbz0iX2IyODE3NWMzLTU5ODEtNDg2My1iYjYwLTdlZWI5ZDk1NmUwMyIgSXNzdWVJbnN0YW50PSIyMDIyLTAxLTE3VDEwOjQzOjEyLjMzMloiIFZlcnNpb249IjIuMCIgeG1sbnM6c2FtbDJwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSI+PHNhbWwyOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly93d3cub2t0YS5jb20vZXhrM2xhbW00blRJazFjRks1ZDc8L3NhbWwyOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzOlJlZmVyZW5jZSBVUkk9IiNpZDEzMDA0NTY4NDg5MDY0MTU1NzE3MTI0Nzc5Ij48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIj48ZWM6SW5jbHVzaXZlTmFtZXNwYWNlcyBQcmVmaXhMaXN0PSJ4cyIgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3JtPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPkFwSm1NUW1EYmpRRE40bEFLUWlPMnMzK3p3Z1o3MktmdXRzbFpJZmJhZFk9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8+PGRzOlNpZ25hdHVyZVZhbHVlPkRmMjVXbzVwTm9QRnhQMERUQ0Jmc0Vlc21mejJON2VhU3lXNUIwUVlxK3lyQktMQTRxdDR0RnJ2WmFJczFZNWpBaGIzVzhvZVhXVUV1b2RabGQ2WjloWnd6b0JPa09YcnpKc1F5eWQzNWkxaHVxRmJ3dklYWEdFd2g2Ykt6RnErSmxjcmZkdzdPN3Focm9QR1B5QWN1ZGpGZVBENkFxb2hTdmpFTnlwS0FHOU1hVlRwai9vbWo4YzAzdTI0Um1FcWp3TWU2Nm1PbnhjK1EzK2N4dmFBSy9KWkVpSE1mUTFUcmpQcllPeEFDS2lsSmgveVphalBVM1MxcWZsclFQRDhocFRkRDVBS2kxZWs4R2g2ZzF5akJjTU80aXFqZ3RGUkg3QkQ0TGRNTGtoUmxMTkxZb0V1VmpGa05lNElWQ0N0cVRpYWRNSkFnRHRCY3c2dXQ4a1p0UT09PC9kczpTaWduYXR1cmVWYWx1ZT48ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlEcGpDQ0FvNmdBd0lCQWdJR0FYNVNPVE9aTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdUTVFzd0NRWURWUVFHRXdKVlV6RVRNQkVHCkExVUVDQXdLUTJGc2FXWnZjbTVwWVRFV01CUUdBMVVFQnd3TlUyRnVJRVp5WVc1amFYTmpiekVOTUFzR0ExVUVDZ3dFVDJ0MFlURVUKTUJJR0ExVUVDd3dMVTFOUFVISnZkbWxrWlhJeEZEQVNCZ05WQkFNTUMyUmxkaTA1TnpnNE5EQXlNUnd3R2dZSktvWklodmNOQVFrQgpGZzFwYm1adlFHOXJkR0V1WTI5dE1CNFhEVEl5TURFeE16QTJOVFV5TjFvWERUTXlNREV4TXpBMk5UWXlOMW93Z1pNeEN6QUpCZ05WCkJBWVRBbFZUTVJNd0VRWURWUVFJREFwRFlXeHBabTl5Ym1saE1SWXdGQVlEVlFRSERBMVRZVzRnUm5KaGJtTnBjMk52TVEwd0N3WUQKVlFRS0RBUlBhM1JoTVJRd0VnWURWUVFMREF0VFUwOVFjbTkyYVdSbGNqRVVNQklHQTFVRUF3d0xaR1YyTFRrM09EZzBNREl4SERBYQpCZ2txaGtpRzl3MEJDUUVXRFdsdVptOUFiMnQwWVM1amIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRQ0xPSmxTMlprYTdrWFdncEFrQjlkTWlWT0s0Yk93T0VyckgxZjIxSlNwTXFTTzJOZ0FUZ1VCZHlKWjcvQ0k1S09wZUk3RmVtUGsKQnhBVkg4Um85ZkV1R0RTZW00SmRiSG9MSmNEbG9YU2pJVzYrQ0JvTWpXeGdjZFZMTFpCRmJ6TFVaSW1uYTZLeUJVOE5LclpRSldBcgpXYmc1UUdIVGxkdHVIeFJ3bUhOWTVhaFdVUEdSN3B2ZStIQzZBZVNpUkJIQ2VBamZ5VkNLK3FKWS8yTUxqRStoajJVbEkreHZwcVJHCjB0bkV5ZFpRZzdVamdiZnhUZmVVd0ZydmNucm5BaFZDU25EM2VXbTNJdVhVQ284TGRscXpEaEVCeWJnbjdKTlArbkN1bDlXTndRR0EKUFZBZXdkeFdxeTZoeHBmeUgyVVY2WE5mV3VCNG9BakdlbnY0cCtaUkFnTUJBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUhWVgpObnduRjBIMDNOZy90anRoOFlUcDExdWFMejlPZXVlSE5SS2FWNWc5OHhMbWZXaTgvV1daeDI4V3hwdkpvU1Z6T09tVHpMOTZNRlhqCnZBVzl2YU85aFdRaGJ4UzBJOEloTXM1VE9Fdkc0TjdST3JTcit0UkJIdzd0Q0ZKbXhSSUExZEpVTU93KythQ25EcS9TV0dzQmRZS3gKdjVFZVBFOVJYTTdxRFFKcVUyVTJDbGNkaUkyUlV0elptdHR6eWlURUVaSjVnUVNLRVJrY0dMWHdEdG1wSnNDNDc2NlBBSFRVYmhmOApkc25hcVBWbTkreFhpUEs2MFdzUzhKRlBGQjd5dmtvV2ZCQ2kyMlFSbGJyQU1jcHdPU3EyTzhZWVJMOWdnYVZRaERBVXlOMmtxTCsyCjFmZ2dhazRwNzU0VndrNnBkWnZoSklSUGpHZXNGVzkySFJRPTwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sMnA6U3RhdHVzIHhtbG5zOnNhbWwycD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnByb3RvY29sIj48c2FtbDJwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvc2FtbDJwOlN0YXR1cz48c2FtbDI6QXNzZXJ0aW9uIElEPSJpZDEzMDA0NTY4NDg5MTM5ODU2MTI1NzYyNTMyOCIgSXNzdWVJbnN0YW50PSIyMDIyLTAxLTE3VDEwOjQzOjEyLjMzMloiIFZlcnNpb249IjIuMCIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSI+PHNhbWwyOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly93d3cub2t0YS5jb20vZXhrM2xhbW00blRJazFjRks1ZDc8L3NhbWwyOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzOlJlZmVyZW5jZSBVUkk9IiNpZDEzMDA0NTY4NDg5MTM5ODU2MTI1NzYyNTMyOCI+PGRzOlRyYW5zZm9ybXM+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyI+PGVjOkluY2x1c2l2ZU5hbWVzcGFjZXMgUHJlZml4TGlzdD0ieHMiIHhtbG5zOmVjPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybT48L2RzOlRyYW5zZm9ybXM+PGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI3NoYTI1NiIvPjxkczpEaWdlc3RWYWx1ZT5WWUx0Q3FpYnY2SlNKMEFRR1lubkxwelFQdUxNMks5MnRUNldEalIyd244PTwvZHM6RGlnZXN0VmFsdWU+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5KejlCT0ZVbGdldG1VZldSMnJ6dkE0THNIc3d5aEpMWFEzVTA2c2lmUnpKUkp2S3NFcEplOVlVaTlsbFBSbUVQU2V0UldGWnlBenVDd0dHQjNrM21RSXlhRUQwcmJqN1FFblFSU014WWI5R2pRWlFDam8xUU11M1JjK3NHYWhheEh2QkdmdERZTTAyeW1tWkNtVUtiN2NsWXYwMlROeHk2aHhZTHhoTVpuTTl3NlJ0bFltUFBNM2pOVTk0K3pBYzY3NjJYUWpqZk9qZ3duNXN0ZDMzVk9jb1hwQXdDNEN5b3Vpc1RUbitVVzdDZ0RTeUd6cmREY2JqTk53T0ErZDJlcDRwSW5Md0p5d2RWdUlkVE1RQ1Z2VEQyTGNmOUNvbGY3MUJDc04xckFoQStxVDJ0Wkp5Rm1PQUxjaHBKeXRzZWsxU0hSajBhMUpSeEp4WEdRZG1mRXc9PTwvZHM6U2lnbmF0dXJlVmFsdWU+PGRzOktleUluZm8+PGRzOlg1MDlEYXRhPjxkczpYNTA5Q2VydGlmaWNhdGU+TUlJRHBqQ0NBbzZnQXdJQkFnSUdBWDVTT1RPWk1BMEdDU3FHU0liM0RRRUJDd1VBTUlHVE1Rc3dDUVlEVlFRR0V3SlZVekVUTUJFRwpBMVVFQ0F3S1EyRnNhV1p2Y201cFlURVdNQlFHQTFVRUJ3d05VMkZ1SUVaeVlXNWphWE5qYnpFTk1Bc0dBMVVFQ2d3RVQydDBZVEVVCk1CSUdBMVVFQ3d3TFUxTlBVSEp2ZG1sa1pYSXhGREFTQmdOVkJBTU1DMlJsZGkwNU56ZzROREF5TVJ3d0dnWUpLb1pJaHZjTkFRa0IKRmcxcGJtWnZRRzlyZEdFdVkyOXRNQjRYRFRJeU1ERXhNekEyTlRVeU4xb1hEVE15TURFeE16QTJOVFl5TjFvd2daTXhDekFKQmdOVgpCQVlUQWxWVE1STXdFUVlEVlFRSURBcERZV3hwWm05eWJtbGhNUll3RkFZRFZRUUhEQTFUWVc0Z1JuSmhibU5wYzJOdk1RMHdDd1lEClZRUUtEQVJQYTNSaE1SUXdFZ1lEVlFRTERBdFRVMDlRY205MmFXUmxjakVVTUJJR0ExVUVBd3dMWkdWMkxUazNPRGcwTURJeEhEQWEKQmdrcWhraUc5dzBCQ1FFV0RXbHVabTlBYjJ0MFlTNWpiMjB3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQgpBUUNMT0psUzJaa2E3a1hXZ3BBa0I5ZE1pVk9LNGJPd09FcnJIMWYyMUpTcE1xU08yTmdBVGdVQmR5Slo3L0NJNUtPcGVJN0ZlbVBrCkJ4QVZIOFJvOWZFdUdEU2VtNEpkYkhvTEpjRGxvWFNqSVc2K0NCb01qV3hnY2RWTExaQkZiekxVWkltbmE2S3lCVThOS3JaUUpXQXIKV2JnNVFHSFRsZHR1SHhSd21ITlk1YWhXVVBHUjdwdmUrSEM2QWVTaVJCSENlQWpmeVZDSytxSlkvMk1MakUraGoyVWxJK3h2cHFSRwowdG5FeWRaUWc3VWpnYmZ4VGZlVXdGcnZjbnJuQWhWQ1NuRDNlV20zSXVYVUNvOExkbHF6RGhFQnliZ243Sk5QK25DdWw5V053UUdBClBWQWV3ZHhXcXk2aHhwZnlIMlVWNlhOZld1QjRvQWpHZW52NHArWlJBZ01CQUFFd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFIVlYKTm53bkYwSDAzTmcvdGp0aDhZVHAxMXVhTHo5T2V1ZUhOUkthVjVnOTh4TG1mV2k4L1dXWngyOFd4cHZKb1NWek9PbVR6TDk2TUZYagp2QVc5dmFPOWhXUWhieFMwSThJaE1zNVRPRXZHNE43Uk9yU3IrdFJCSHc3dENGSm14UklBMWRKVU1PdysrYUNuRHEvU1dHc0JkWUt4CnY1RWVQRTlSWE03cURRSnFVMlUyQ2xjZGlJMlJVdHpabXR0enlpVEVFWko1Z1FTS0VSa2NHTFh3RHRtcEpzQzQ3NjZQQUhUVWJoZjgKZHNuYXFQVm05K3hYaVBLNjBXc1M4SkZQRkI3eXZrb1dmQkNpMjJRUmxickFNY3B3T1NxMk84WVlSTDlnZ2FWUWhEQVV5TjJrcUwrMgoxZmdnYWs0cDc1NFZ3azZwZFp2aEpJUlBqR2VzRlc5MkhSUT08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDI6U3ViamVjdCB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWwyOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMTpuYW1laWQtZm9ybWF0OnVuc3BlY2lmaWVkIj50aG9uZ2RtMkB2aWV0dGVsLmNvbS52bjwvc2FtbDI6TmFtZUlEPjxzYW1sMjpTdWJqZWN0Q29uZmlybWF0aW9uIE1ldGhvZD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmNtOmJlYXJlciI+PHNhbWwyOlN1YmplY3RDb25maXJtYXRpb25EYXRhIEluUmVzcG9uc2VUbz0iX2IyODE3NWMzLTU5ODEtNDg2My1iYjYwLTdlZWI5ZDk1NmUwMyIgTm90T25PckFmdGVyPSIyMDIyLTAxLTE3VDEwOjQ4OjEyLjMzMloiIFJlY2lwaWVudD0iaHR0cDovL2xvY2FsaG9zdDozMDAxL21zci9zYW1sL2F1dGgiLz48L3NhbWwyOlN1YmplY3RDb25maXJtYXRpb24+PC9zYW1sMjpTdWJqZWN0PjxzYW1sMjpDb25kaXRpb25zIE5vdEJlZm9yZT0iMjAyMi0wMS0xN1QxMDozODoxMi4zMzJaIiBOb3RPbk9yQWZ0ZXI9IjIwMjItMDEtMTdUMTA6NDg6MTIuMzMyWiIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPjxzYW1sMjpBdWRpZW5jZVJlc3RyaWN0aW9uPjxzYW1sMjpBdWRpZW5jZT5odHRwOi8vbG9jYWxob3N0OjMwMDEvbXNyL3NhbWwvbWV0YWRhdGE8L3NhbWwyOkF1ZGllbmNlPjwvc2FtbDI6QXVkaWVuY2VSZXN0cmljdGlvbj48L3NhbWwyOkNvbmRpdGlvbnM+PHNhbWwyOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyMi0wMS0xN1QxMDo0MzoxMi4zMzJaIiBTZXNzaW9uSW5kZXg9Il9iMjgxNzVjMy01OTgxLTQ4NjMtYmI2MC03ZWViOWQ5NTZlMDMiIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6QXV0aG5Db250ZXh0PjxzYW1sMjpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDI6QXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9zYW1sMjpBdXRobkNvbnRleHQ+PC9zYW1sMjpBdXRoblN0YXRlbWVudD48c2FtbDI6QXR0cmlidXRlU3RhdGVtZW50IHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6QXR0cmlidXRlIE5hbWU9IkZpcnN0IG5hbWUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dW5zcGVjaWZpZWQiPjxzYW1sMjpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPlRob25nPC9zYW1sMjpBdHRyaWJ1dGVWYWx1ZT48L3NhbWwyOkF0dHJpYnV0ZT48c2FtbDI6QXR0cmlidXRlIE5hbWU9Ikxhc3QgbmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1bnNwZWNpZmllZCI+PHNhbWwyOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+RG88L3NhbWwyOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDI6QXR0cmlidXRlPjxzYW1sMjpBdHRyaWJ1dGUgTmFtZT0iRW1haWwiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dW5zcGVjaWZpZWQiPjxzYW1sMjpBdHRyaWJ1dGVWYWx1ZSB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPnRob25nZG0yQHZpZXR0ZWwuY29tLnZuPC9zYW1sMjpBdHRyaWJ1dGVWYWx1ZT48L3NhbWwyOkF0dHJpYnV0ZT48c2FtbDI6QXR0cmlidXRlIE5hbWU9IkxvZ2luIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVuc3BlY2lmaWVkIj48c2FtbDI6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hIiB4bWxuczp4c2k9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvWE1MU2NoZW1hLWluc3RhbmNlIiB4c2k6dHlwZT0ieHM6c3RyaW5nIj50aG9uZ2RtMkB2aWV0dGVsLmNvbS52bjwvc2FtbDI6QXR0cmlidXRlVmFsdWU+PC9zYW1sMjpBdHRyaWJ1dGU+PC9zYW1sMjpBdHRyaWJ1dGVTdGF0ZW1lbnQ+PC9zYW1sMjpBc3NlcnRpb24+PC9zYW1sMnA6UmVzcG9uc2U+"
		}

		assertionInfo, err := sp.RetrieveAssertionInfo(samlResponse)
		if err != nil {
			fmt.Printf("assertion err: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.InvalidTime {
			fmt.Printf("Invalid time: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		if assertionInfo.WarningInfo.NotInAudience {
			fmt.Printf("Not in audience: %s", err)
			rw.WriteHeader(http.StatusForbidden)
			return
		}

		fmt.Fprintf(rw, "NameID: %s\n", assertionInfo.NameID)

		fmt.Fprintf(rw, "Assertions:\n")

		for key, val := range assertionInfo.Values {
			fmt.Fprintf(rw, "  %s: %+v\n", key, val)
		}

		fmt.Fprintf(rw, "\n")

		fmt.Fprintf(rw, "Warnings:\n")
		fmt.Fprintf(rw, "%+v\n", assertionInfo.WarningInfo)
	})

	// println("Visit this URL To Authenticate:")

	// println(authURL)

	// println("Supply:")
	// fmt.Printf("  SP ACS URL      : %s\n", sp.AssertionConsumerServiceURL)

	err = http.ListenAndServe(":3001", nil)
	if err != nil {
		panic(err)
	}
}

func render(w http.ResponseWriter, path string, data interface{}) {
	w.Header().Set("Content-Type", "text/html")
	w.Header().Set("Cache-Control", "no-store")
	w.Header().Set("Pragma", "no-cache")
	w.WriteHeader(http.StatusOK)
	tlp := template.Must(template.ParseFiles(path))
	tlp.Execute(w, data)
}
